suite: Test Gitaly Resources
templates:
  - gitaly/configmap.yaml
  - gitaly/service.yaml
  - gitaly/statefulset.yaml
release:
  name: csghub
  namespace: csghub
set:
  global:
    image:
      registry: "docker.io"
      registryPolicy: "default"
      pullPolicy: "Never"
      pullSecrets: ["acr-pull-secret"]
    persistence:
      storageClass: "nfs-provisioner"
      accessModes: ["ReadWriteOnce", "ReadWriteMany"]
      size: "25Gi"
    gitaly:
      enabled: true
  gitaly:
    name: "gitaly"
    image:
      registry: "registry.gitlab.com"
      repository: "gitlab-org/build/cng/gitaly"
      tag: "v18.0.0"
      pullPolicy: ""
    service:
      type: "ClusterIP"
      port: 8075
      protocol: TCP
    persistence:
      size: ""
tests:
  - it: Should render all resources correctly
    templates:
      - gitaly/configmap.yaml
      - gitaly/service.yaml
      - gitaly/statefulset.yaml
    asserts:
      - equal:
          path: metadata.name
          value: "csghub-gitaly"
      - equal:
          path: metadata.labels["app.kubernetes.io/service"]
          value: "gitaly"

  - it: Should render secret correctly
    template: gitaly/configmap.yaml
    set:
      server:
        name: "server"
        service:
          port: 8080
    asserts:
      - equal:
          path: metadata.name
          value: "csghub-gitaly"
      - equal:
          path: metadata.labels["app.kubernetes.io/service"]
          value: "gitaly"
      - matchRegex:
          path: data["config.toml"]
          pattern: "http://csghub-server:8080"

  - it: Should render service correctly
    template: gitaly/service.yaml
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/service"]
          value: "gitaly"

  - it: Should render deployment with global correctly
    template: gitaly/statefulset.yaml
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/service"]
          value: "gitaly"
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/service"]
          value: "gitaly"
      - equal:
          path: metadata.annotations["reloader.stakater.com/auto"]
          value: "true"
      - equal:
          path: spec.serviceName
          value: "csghub-gitaly"
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: "acr-pull-secret"
      - equal:
          path: spec.template.spec.containers[0].image
          value: "registry.gitlab.com/gitlab-org/build/cng/gitaly:v18.0.0"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "Never"
      - equal:
          path: spec.volumeClaimTemplates[0].spec.accessModes
          value: ["ReadWriteOnce", "ReadWriteMany"]
      - equal:
          path: spec.volumeClaimTemplates[0].spec.storageClassName
          value: "nfs-provisioner"
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: "25Gi"

  - it: Should render statefulset with local correctly
    template: gitaly/statefulset.yaml
    set:
      global:
        image:
          registry: "opencsg-registry.cn-beijing.cr.aliyuncs.com"
          registryPolicy: "force"
      gitaly:
        image:
          pullPolicy: "IfNotPresent"
          pullSecrets: ["docker-pull-secret"]
        persistence:
          accessModes: ["ReadWriteOnce"]
          storageClass: "hostPath"
          size: "100Gi"
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: "docker-pull-secret"
      - equal:
          path: spec.template.spec.containers[0].image
          value: "opencsg-registry.cn-beijing.cr.aliyuncs.com/opencsghq/gitlab-org/build/cng/gitaly:v18.0.0"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "IfNotPresent"
      - equal:
          path: spec.volumeClaimTemplates[0].spec.accessModes
          value: ["ReadWriteOnce"]
      - equal:
          path: spec.volumeClaimTemplates[0].spec.storageClassName
          value: "hostPath"
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: "100Gi"
