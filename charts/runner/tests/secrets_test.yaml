# tests/secret_test.yaml
suite: secrets testing
templates:
  - secret.yaml
release:
  name: runner
  namespace: csghub
tests:
  - it: should create docker registry secret with correct structure
    asserts:
      - isKind:
          of: Secret
      - isAPIVersion:
          of: v1
      - equal:
          path: type
          value: kubernetes.io/dockerconfigjson
      - exists:
          path: data[".dockerconfigjson"]

  - it: should contain correct registry info in docker config
    set:
      global:
        registry:
          enabled: false
          external:
            registry: "registry.example.com"
            namespace: "csghub_global"
            username: "registry_global"
            password: "ae45f28bf9c9fd76"
            insecure: false
    asserts:
      - matchRegex:
          path: data[".dockerconfigjson"]
          pattern: "registry.example.com"
          decodeBase64: true
      - matchRegex:
          path: data[".dockerconfigjson"]
          pattern: "registry_global"
          decodeBase64: true
      - matchRegex:
          path: data[".dockerconfigjson"]
          pattern: "ae45f28bf9c9fd76"
          decodeBase64: true
      - matchRegex:
          path: data[".dockerconfigjson"]
          pattern: "cmVnaXN0cnlfZ2xvYmFsOmFlNDVmMjhiZjljOWZkNzY="
          decodeBase64: true

  - it: should overwrite registry info by local
    set:
      registry:
        registry: "registry.example.cn"
        namespace: "csghub_local"
        username: "registry_local"
        password: "68b329da9893e340"
        insecure: false
    asserts:
      - matchRegex:
          path: data[".dockerconfigjson"]
          pattern: "registry.example.cn"
          decodeBase64: true
      - matchRegex:
          path: data[".dockerconfigjson"]
          pattern: "registry_local"
          decodeBase64: true
      - matchRegex:
          path: data[".dockerconfigjson"]
          pattern: "68b329da9893e340"
          decodeBase64: true
      - matchRegex:
          path: data[".dockerconfigjson"]
          pattern: "cmVnaXN0cnlfbG9jYWw6NjhiMzI5ZGE5ODkzZTM0MA=="
          decodeBase64: true
