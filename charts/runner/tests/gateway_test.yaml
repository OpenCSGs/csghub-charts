suite: Test Runner Gateway
templates:
  - gateway.yaml
  - httproutes.yaml
release:
  name: csghub
  namespace: csghub
set:
  global:
    gateway:
      controllerName: "gateway.envoyproxy.io/gatewayclass-controller"
      external:
        domain: "csghub.example.cn"
      tls:
        enabled: true
        secretName: "example-cn-tls"
      service:
        type: "NodePort"
    chartContext:
      isBuiltIn: false
  name: "runner-svc"
  service:
    port: 8082
tests:
  - it: Should render gateway correctly
    template: gateway.yaml
    documentIndex: 0
    asserts:
      - equal:
          path: spec.controllerName
          value: "gateway.envoyproxy.io/gatewayclass-controller"

  - it: Should render gateway correctly
    template: gateway.yaml
    documentIndex: 1
    asserts:
      - equal:
          path: spec.listeners[1].protocol
          value: "HTTPS"
      - equal:
          path: spec.listeners[1].tls.certificateRefs[0].name
          value: "example-cn-tls"

  - it: Should render gateway correctly with local
    template: gateway.yaml
    documentIndex: 1
    set:
      gateway:
        tls:
          secretName: "example-cn-tls-local"
    asserts:
      - equal:
          path: spec.listeners[1].tls.certificateRefs[0].name
          value: "example-cn-tls-local"

  - it: Should render httpRoutes correctly
    template: httproutes.yaml
    asserts:
      - contains:
          path: spec.hostnames
          content: "runner-svc.example.cn"
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: "csghub-runner-svc"
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 8082
