workflow:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+.\d+.\d+$/
      
stages:
  - package
  - publish

variables:
  CHART_PATH: "charts/csghub"
  HELM_REGISTRY: "https://charts.opencsg.com/repository/csghub"
  CHARTS: "charts/csghub charts/runner charts/dataflow charts/csgship"


package:
  stage: package
  image: opencsg-registry.cn-beijing.cr.aliyuncs.com/opencsg_public/helmpack/chart-testing:v3.13.0
  script:
    - |
      sed -i "s/^version:.*/version: ${CI_COMMIT_TAG#v}/" charts/csghub/Chart.yaml
      sed -i "s/^appVersion:.*/appVersion: \"${CI_COMMIT_TAG}\"/" charts/csghub/Chart.yaml
      sed -i "s/^    tag:.*/    tag: \"${CI_COMMIT_TAG}\"/" charts/csghub/values.yaml
      
      echo "Verify version updated:"
      sed -n "/${CI_COMMIT_TAG#v}/p" charts/csghub/{values.yaml,Chart.yaml} | sed 's/^    //g'
    - |
      for CHART_PATH in $CHARTS; do
        echo "ðŸš€ Packaging $CHART_PATH"
        helm dependency update "$CHART_PATH"
        helm package "$CHART_PATH" -d ./
      done

      echo "ðŸ“¤ Uploading all charts..."
      for pkg in *.tgz; do
        echo "â†’ Uploading $pkg"
        curl -sSf -u "${HELM_REGISTRY_USER}:${HELM_REGISTRY_PASSWORD}" \
          --upload-file "$pkg" \
          "${HELM_REGISTRY}" || echo $?
      done
  artifacts:
    paths:
      - "*.tgz"
    expire_in: 1 week

