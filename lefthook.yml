# lefthook.yml - Helm Charts Pre-commit Hooks Configuration
# åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ä¿å­˜æ­¤æ–‡ä»¶ï¼Œç„¶åè¿è¡Œ: lefthook install
pre-commit:
  parallel: true
  commands:
    # æ£€æŸ¥ Helm chart è¯­æ³•å’Œç»“æ„
    helm-lint:
      run: |
        echo "ğŸ” Running Helm lint..."
        if ! helm lint charts/csghub; then
          echo "âŒ Helm lint failed for charts"
        fi
        
        echo "âœ… Helm lint passed"

    # æ£€æŸ¥ Helm æ¨¡æ¿æ¸²æŸ“
    helm-template:
      run: |
        echo "ğŸ” Running Helm template dry-run..."
        
        # ä½¿ç”¨é»˜è®¤å€¼è¿›è¡Œæ¨¡æ¿æ¸²æŸ“æµ‹è¯•
        if ! helm template test-release charts/csghub --dry-run > /dev/null 2>&1; then
          echo "âŒ Template rendering failed"
          helm template test-release charts/csghub --dry-run
        fi
        
        echo "âœ… Helm template rendering passed"

    # è¿è¡Œ Helm unittest
    helm-unittest:
      run: |
        echo "ğŸ” Running Helm unittest..."
        
        # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† helm unittest æ’ä»¶
        if ! helm plugin list | grep -q unittest; then
          echo "âŒ Helm unittest plugin not installed. Install with:"
          echo "   helm plugin install https://github.com/helm-unittest/helm-unittest"
          exit 1
        fi
        
        # è¿è¡Œå•å…ƒæµ‹è¯•
        if ! helm unittest charts/csghub; then
          echo "âŒ Helm unittest failed"
          exit 1
        fi
        echo "âœ… Helm unittest passed"

# æäº¤ä¿¡æ¯æ£€æŸ¥
commit-msg:
  commands:
    conventional-commit:
      run: |
        echo "ğŸ” Checking commit message format..."
        commit_msg=$(cat {1})
        
        # æ£€æŸ¥ Conventional Commits æ ¼å¼ - ä½¿ç”¨ grep æ›¿ä»£ bash æ­£åˆ™è¡¨è¾¾å¼
        if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+"; then
          echo "âŒ Commit message should follow Conventional Commits format:"
          echo "   feat: add new feature"
          echo "   fix: fix bug"
          echo "   docs: update documentation"
          echo "   style: formatting changes"
          echo "   refactor: code refactoring"
          echo "   test: add tests"
          echo "   chore: maintenance tasks"
          exit 1
        fi
        echo "âœ… Commit message format is valid"
        